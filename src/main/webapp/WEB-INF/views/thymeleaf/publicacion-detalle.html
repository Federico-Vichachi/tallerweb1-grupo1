<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${publicacion != null ? publicacion.titulo : 'Publicación no encontrada'}"></title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" th:href="@{/css/publicacion-detalle.css}"/>
</head>
<body>

<div class="container detalle-container">
    <a th:href="@{/feed}" class="btn btn-outline-secondary mb-4"><i class="fa-solid fa-arrow-left"></i> Volver al Feed</a>

    <div th:if="${publicacion != null}" class="publicacion-card">
        <div class="row g-5">
            <!-- COLUMNA IZQUIERDA -->
            <div class="col-lg-8">
                <img th:src="@{${publicacion.imagen}}" alt="Imagen de la publicación" class="publicacion-imagen mb-4">

                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h1 class="fw-bold" th:text="${publicacion.titulo}"></h1>
                    <span class="tag-detalle"
                          th:classappend="${'tag-' + #strings.toLowerCase(publicacion.class.simpleName.replace('Publicacion',''))}"
                          th:text="${#strings.capitalize(publicacion.class.simpleName.replace('Publicacion',''))}">
                    </span>
                </div>

                <div th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionRecaudacion)}" class="recaudacion-progreso">
                    <div class="d-flex justify-content-between">
                        <span>Meta: <span class="fw-bold" th:text="'$' + ${publicacion.meta}"></span></span>
                        <span class="recaudado">Recaudado: <span th:text="'$' + ${publicacion.montoActual}"></span></span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar" role="progressbar" th:style="'width: ' + (${publicacion.meta > 0 ? (publicacion.montoActual / publicacion.meta * 100) : 0}) + '%;'"></div>
                    </div>
                </div>

                <h4 class="titulo-seccion">Sobre este caso</h4>
                <p class="lead" th:text="${publicacion.descripcionDetallada}"></p>

                <div th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionPerdido)} or ${publicacion instanceof T(com.tallerwebi.dominio.PublicacionSalud)}">
                    <h4 class="titulo-seccion">Informacion Adicional</h4>
                    <ul class="list-group list-group-flush">
                        <th:block th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionPerdido)}">
                            <li class="list-group-item bg-transparent"><strong>Desapareció:</strong> <span th:text="${publicacion.fechaDesaparicion} + ' a las ' + ${publicacion.horaDesaparicion} + ' hs'"></span></li>
                            <li class="list-group-item bg-transparent"><strong>Llevaba collar:</strong> <span th:text="${publicacion.llevaCollar ? 'Sí' : 'No'}"></span></li>
                            <li class="list-group-item bg-transparent"><strong>Recompensa:</strong> <span th:text="${publicacion.recompensa}"></span></li>
                        </th:block>
                        <th:block th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionSalud)}">
                            <li class="list-group-item bg-transparent"><strong>Nivel de Urgencia:</strong> <span th:text="${publicacion.nivelUrgencia}"></span></li>
                            <li class="list-group-item bg-transparent"><strong>Síntomas:</strong> <span th:text="${publicacion.sintomasPrincipales}"></span></li>
                            <li class="list-group-item bg-transparent"><strong>Diagnóstico:</strong> <span th:text="${publicacion.diagnostico}"></span></li>
                        </th:block>
                    </ul>
                </div>

                <!-- SECCIÓN DE COMENTARIOS -->
                <div class="mt-5">
                    <h4 class="titulo-seccion">Comentarios (<span th:text="${#lists.size(publicacion.comentarios)}"></span>)</h4>

                    <div th:if="${session.usuarioLogueado == null}" class="alert alert-info">
                        <a th:href="@{/inicio-de-sesion}">Inicia sesion</a> para dejar un comentario.
                    </div>

                    <form th:if="${session.usuarioLogueado != null}" th:action="@{/comentario/guardar}" method="post" class="mb-4">
                        <input type="hidden" name="publicacionId" th:value="${publicacion.id}" />
                        <div class="mb-2">
                            <textarea name="texto" class="form-control" rows="3" placeholder="Escribe un comentario..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Comentar</button>
                        <div th:if="${errorComentario}" class="alert alert-danger mt-2" th:text="${errorComentario}"></div>
                    </form>

                    <div th:if="${#lists.isEmpty(publicacion.comentarios)}">
                        <p>Todavia no hay comentarios. </p>
                    </div>
                    <div th:each="comentario : ${publicacion.comentarios}" class="card mb-3">
                        <div class="card-body">
                            <strong><i class="fa-solid fa-user"></i> <span th:text="${comentario.autor.nombreDeUsuario}"></span></strong>

                            <small class="text-muted float-end" th:text="${T(java.time.format.DateTimeFormatter).ofPattern('dd/MM/yyyy HH:mm').format(comentario.fechaCreacion)}"></small>

                            <p class="card-text mt-2" th:text="${comentario.texto}"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA -->
            <div class="col-lg-4 info-sidebar">
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fa-solid fa-circle-info"></i> Información General</h5></div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Ubicacion:</strong> <span th:text="${publicacion.localidad} + ', ' + ${#strings.capitalizeWords(publicacion.provincia.toString().replace('_',' ').toLowerCase())}"></span></li>
                        <li class="list-group-item"><strong>Raza:</strong> <span th:text="${publicacion.raza}"></span></li>
                        <li class="list-group-item"><strong>Tamaño Aprox:</strong> <span th:text="${publicacion.tamanio} + ' cm'"></span></li>
                        <li class="list-group-item" th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionAdopcion) or publicacion instanceof T(com.tallerwebi.dominio.PublicacionRecaudacion) or publicacion instanceof T(com.tallerwebi.dominio.PublicacionSalud)}">
                            <strong>Edad:</strong> <span th:text="${publicacion.edad} + ' años'"></span>
                        </li>
                    </ul>
                </div>
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fa-solid fa-address-book"></i> Contacto</h5></div>
                    <div class="card-body">
                        <p><i class="fa-solid fa-envelope me-2"></i><span th:text="${publicacion.email}"></span></p>
                        <p><i class="fa-solid fa-phone me-2"></i><span th:text="${publicacion.telefono}"></span></p>
                        <a th:href="@{/chat(iniciarCon=${publicacion.usuario.nombreDeUsuario})}" class="btn btn-success w-100 mt-2"><i class="fa-solid fa-comments"></i> Consultar por Chat</a>
                    </div>
                </div>
                <div class="card" th:if="${publicacion.latitud != null and publicacion.longitud != null}">
                    <div class="card-header"><h5 class="mb-0"><i class="fa-solid fa-map-location-dot"></i> Ubicacion en Mapa</h5></div>
                    <div class="card-body p-0"><div id="map"></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h5 class="mb-0"><i class="fa-solid fa-user"></i> Publicado por</h5></div>
                    <div class="card-body">
                        <h6 th:text="${publicacion.usuario.nombreDeUsuario}"></h6>
                        <span class="badge bg-secondary" th:text="${#strings.capitalizeWords(publicacion.usuario.rol.toString().replace('_',' ').toLowerCase())}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:if="${publicacion == null}" class="alert alert-warning text-center">
        <h2>Publicación no encontrada</h2>
        <p>La publicación que buscas no existe o ha sido eliminada.</p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script th:inline="javascript" th:if="${publicacion?.latitud != null}">
    const lat = /*[[${publicacion.latitud}]]*/ 0;
    const lon = /*[[${publicacion.longitud}]]*/ 0;
    const tipo = /*[[${publicacion.class.simpleName.replace('Publicacion','')}]]*/ '';
    const map = L.map('map').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    L.marker([lat, lon]).addTo(map).bindPopup('Ubicación aproximada del caso ' + tipo).openPopup();
</script>
</body>
</html>