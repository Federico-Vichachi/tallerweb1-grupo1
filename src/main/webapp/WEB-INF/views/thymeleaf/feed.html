<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed de Publicaciones</title>
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" th:href="@{/css/variables.css}"/>
    <link rel="stylesheet" th:href="@{/css/footer.css}"/>
    <link rel="stylesheet" th:href="@{/css/feed.css}"/>
    <script th:inline="javascript">
        const contextPath = /*[[@{/}]]*/ '';
    </script>
</head>
<body>

<div class="container-fluid px-3 px-md-4 py-4">
    <div class="row g-3 g-lg-4">
        <!-- COLUMNA DE FILTROS -->
        <div class="col-12 col-lg-4 col-xl-3">
            <aside class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-body p-3 p-md-4">
                    <form th:action="@{/feed}" method="GET" id="form-filtros">
                        <!-- Título Filtros -->
                        <h3 class="h5 fw-bold mb-4 d-flex align-items-center gap-2">
                            <i class="fa-solid fa-filter text-dark"></i> Filtros
                        </h3>

                        <!-- Búsqueda -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold small">Buscar</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fa-solid fa-magnifying-glass text-muted"></i>
                                </span>
                                <input type="text"
                                       name="nombre"
                                       class="form-control border-start-0 ps-0"
                                       placeholder="Buscar por título..."
                                       th:value="${nombreFiltro}">
                            </div>
                        </div>

                        <!-- Categorías -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold small">Categorías</label>
                            <div class="d-flex flex-column gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoria" value="ADOPCION"
                                           id="cat-adopcion" th:checked="${categoriaFiltro=='ADOPCION'}">
                                    <label class="form-check-label" for="cat-adopcion">Adopción</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoria" value="PERDIDO"
                                           id="cat-perdido" th:checked="${categoriaFiltro=='PERDIDO'}">
                                    <label class="form-check-label" for="cat-perdido">Perdido</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoria" value="ENCONTRADO"
                                           id="cat-encontrado" th:checked="${categoriaFiltro=='ENCONTRADO'}">
                                    <label class="form-check-label" for="cat-encontrado">Encontrado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoria" value="SALUD"
                                           id="cat-salud" th:checked="${categoriaFiltro=='SALUD'}">
                                    <label class="form-check-label" for="cat-salud">Salud</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="categoria" value="RECAUDACION"
                                           id="cat-recaudacion" th:checked="${categoriaFiltro=='RECAUDACION'}">
                                    <label class="form-check-label" for="cat-recaudacion">Recaudación</label>
                                </div>
                            </div>
                        </div>

                        <!-- Ubicación -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold small">Ubicación</label>
                            <div class="mb-3">
                                <label for="provincia" class="form-label small">Provincia</label>
                                <select id="provincia" name="provincia" class="form-select">
                                    <option value="">Todas</option>
                                    <option th:each="p : ${provincias}"
                                            th:value="${p}"
                                            th:text="${#strings.capitalizeWords(p.toString().replace('_', ' ').toLowerCase())}"
                                            th:selected="${p == provinciaFiltro}">
                                    </option>
                                </select>
                            </div>
                            <div>
                                <label for="localidad" class="form-label small">Ciudad / Localidad</label>
                                <input type="text"
                                       id="localidad"
                                       name="localidad"
                                       class="form-control"
                                       placeholder="Ej: La Plata"
                                       th:value="${localidadFiltro}">
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-check me-1"></i> Aplicar Filtros
                            </button>
                            <a th:href="@{/feed}" class="btn btn-outline-secondary">
                                <i class="fa-solid fa-rotate-right me-1"></i> Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </aside>
        </div>

        <!-- COLUMNA DE PUBLICACIONES -->
        <div class="col-12 col-lg-8 col-xl-9">
            <!-- Header con botones -->
            <div class="mb-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-3">
                    <div>
                        <h2 class="h3 fw-bold mb-1">Publicaciones</h2>
                        <p class="text-muted mb-0 small">Explora las últimas publicaciones de la comunidad</p>
                    </div>

                    <!-- Botones de navegación -->
                    <div class="d-flex flex-wrap gap-2">
                        <a th:href="@{/home}" class="btn btn-secondary btn-sm">
                            <i class="fa-solid fa-arrow-left"></i>
                            <span class="d-none d-sm-inline ms-1">Volver al home</span>
                        </a>
                        <a th:if="${usuarioLogueado != null}"
                           th:href="@{/crear-publicacion}"
                           class="btn btn-primary btn-sm">
                            <i class="fa-solid fa-plus"></i>
                            <span class="d-none d-sm-inline ms-1">Crear</span>
                        </a>
                        <a th:if="${usuarioLogueado != null}"
                           th:href="@{/perfil}"
                           class="btn btn-secondary btn-sm">
                            <i class="fa-solid fa-user"></i>
                            <span class="d-none d-sm-inline ms-1">Perfil</span>
                        </a>
                        <a th:href="@{/mapa}" class="btn btn-primary btn-sm text-white">
                            <i class="fa-solid fa-map-location-dot"></i>
                            <span class="d-none d-sm-inline ms-1">Ver Mapa</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Mensajes -->
            <div th:if="${error}" class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="fa-solid fa-triangle-exclamation me-2"></i>
                <span th:text="${error}"></span>
            </div>

            <div th:if="${error == null and publicaciones.isEmpty()}" class="alert alert-info d-flex align-items-center" role="alert">
                <i class="fa-solid fa-circle-info me-2"></i>
                <span th:if="${not #strings.isEmpty(nombreFiltro) or not #strings.isEmpty(categoriaFiltro) or provinciaFiltro != null or not #strings.isEmpty(localidadFiltro)}">
                    No se encontraron publicaciones que coincidan con tu búsqueda.
                </span>
                <span th:if="${#strings.isEmpty(nombreFiltro) and #strings.isEmpty(categoriaFiltro) and provinciaFiltro == null and #strings.isEmpty(localidadFiltro)}">
                    Aún no hay publicaciones.
                </span>
            </div>

            <div th:if="${mensaje}" class="alert alert-info d-flex align-items-center" role="alert">
                <i class="fa-solid fa-circle-info me-2"></i>
                <span th:text="${mensaje}"></span>
            </div>

            <!-- Lista de Publicaciones -->
            <div class="publicaciones-list">
                <div th:each="publicacion : ${publicaciones}" class="mb-4">
                    <div th:switch="${publicacion.class.simpleName}">

                        <!-- PUBLICACIÓN DE RECAUDACIÓN -->
                        <div th:case="'PublicacionRecaudacion'" class="card shadow-sm border-0 overflow-hidden">
                            <!-- Header -->
                            <div class="card-header bg-white border-0 p-3 p-md-4">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar rounded-circle overflow-hidden d-flex align-items-center justify-content-center"
                                             style="width: 50px; height: 50px; min-width: 50px; background-color: #f0f0f0;">
                                            <img th:src="@{${publicacion.usuario.urlFotoDePerfil}}"
                                                 th:alt="${publicacion.usuario.nombre}"
                                                 class="w-100 h-100"
                                                 style="object-fit: cover;">
                                        </div>
                                        <div class="ms-3">
                                            <div class="fw-semibold" th:text="${publicacion.usuario.nombre + ' ' + publicacion.usuario.apellido}"></div>
                                            <div class="small">
                                                <span class="badge bg-light text-secondary me-2"
                                                      th:text="${#strings.capitalizeWords(publicacion.usuario.rol.toString().replace('_', ' ').toLowerCase())}">
                                                </span>
                                                <span class="text-muted"
                                                      th:if="${publicacion.fechaPublicacion != null}"
                                                      th:text="${T(java.time.format.DateTimeFormatter).ofPattern('dd/MM/yyyy HH:mm').format(publicacion.fechaPublicacion)}">
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <span class="badge bg-info bg-gradient px-3 py-2">
                                        <i class="fa-solid fa-hand-holding-dollar me-1"></i> Recaudación
                                    </span>
                                </div>
                            </div>

                            <!-- Body -->
                            <div class="card-body p-3 p-md-4">
                                <div class="row g-3 g-md-4">
                                    <div class="col-12 col-md-4">
                                        <img th:src="@{${publicacion.imagen}}"
                                             alt="Imagen de la mascota"
                                             class="img-fluid rounded w-100"
                                             style="height: 250px; object-fit: cover;">
                                    </div>
                                    <div class="col-12 col-md-8">
                                        <h3 class="h5 fw-bold mb-3" th:text="${publicacion.titulo}"></h3>

                                        <!-- Progress de recaudación -->
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between mb-2 small">
                                                <span>Meta: <strong th:text="${publicacion.meta}"></strong></span>
                                                <span class="text-success">Recaudado: <strong th:text="${publicacion.montoActual}"></strong></span>
                                            </div>
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-warning"
                                                     role="progressbar"
                                                     th:style="'width: ' + (${publicacion.montoActual != null and publicacion.meta > 0 ? (publicacion.montoActual / publicacion.meta * 100) : 0}) + '%;'"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>

                                        <p class="text-muted mb-4" th:text="${publicacion.descripcionCorta}"></p>

                                        <!-- Form de donación -->
                                        <form th:action="@{/donar}" method="POST">
                                            <input type="hidden" name="id" th:value="${publicacion.id}" />
                                            <div class="d-flex flex-wrap gap-2 align-items-center">
                                                <input type="number"
                                                       name="monto"
                                                       class="form-control form-control-sm"
                                                       style="max-width: 120px;"
                                                       placeholder="Monto"
                                                       required
                                                       min="100" />
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fa-solid fa-dollar-sign"></i> Donar
                                                </button>
                                                <a th:href="@{/publicacion/{id}(id=${publicacion.id})}" class="btn btn-secondary btn-sm">
                                                    <i class="fa-solid fa-comments"></i>
                                                    <span th:text="${publicacion.comentarios != null ? #lists.size(publicacion.comentarios) : 0}"></span>
                                                </a>
                                                <a th:href="@{/publicacion/{id}(id=${publicacion.id})}" class="btn btn-dark btn-sm">
                                                    Más info
                                                </a>
                                                <a th:href="@{/chat(iniciarCon=${publicacion.usuario.nombreDeUsuario})}" class="btn btn-warning btn-sm">
                                                    Consultar
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OTRAS PUBLICACIONES (Adopción, Perdido, Encontrado, Salud) -->
                        <div th:case="*" class="card shadow-sm border-0 overflow-hidden">
                            <!-- Header -->
                            <div class="card-header bg-white border-0 p-3 p-md-4">
                                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar rounded-circle overflow-hidden d-flex align-items-center justify-content-center"
                                             style="width: 50px; height: 50px; min-width: 50px; background-color: #f0f0f0;">
                                            <img th:src="@{${publicacion.usuario.urlFotoDePerfil}}"
                                                 th:alt="${publicacion.usuario.nombre}"
                                                 class="w-100 h-100"
                                                 style="object-fit: cover;">
                                        </div>
                                        <div class="ms-3">
                                            <div class="fw-semibold" th:text="${publicacion.usuario.nombre + ' ' + publicacion.usuario.apellido}"></div>
                                            <div class="small">
                                                <span class="badge bg-light text-secondary me-2"
                                                      th:text="${#strings.capitalizeWords(publicacion.usuario.rol.toString().replace('_', ' ').toLowerCase())}">
                                                </span>
                                                <span class="text-muted"
                                                      th:if="${publicacion.fechaPublicacion != null}"
                                                      th:text="${T(java.time.format.DateTimeFormatter).ofPattern('dd/MM/yyyy HH:mm').format(publicacion.fechaPublicacion)}">
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Badge con iconos para cada categoría -->
                                    <span th:if="${publicacion.class.simpleName == 'PublicacionAdopcion'}"
                                          class="badge bg-purple bg-gradient px-3 py-2">
                                        <i class="fa-solid fa-heart me-1"></i> Adopción
                                    </span>
                                    <span th:if="${publicacion.class.simpleName == 'PublicacionPerdido'}"
                                          class="badge bg-danger bg-gradient px-3 py-2">
                                        <i class="fa-solid fa-magnifying-glass me-1"></i> Perdido
                                    </span>
                                    <span th:if="${publicacion.class.simpleName == 'PublicacionEncontrado'}"
                                          class="badge bg-success bg-gradient px-3 py-2">
                                        <i class="fa-solid fa-check-circle me-1"></i> Encontrado
                                    </span>
                                    <span th:if="${publicacion.class.simpleName == 'PublicacionSalud'}"
                                          class="badge bg-warning bg-gradient px-3 py-2">
                                        <i class="fa-solid fa-heart-pulse me-1"></i> Salud
                                    </span>
                                </div>
                            </div>

                            <!-- Body -->
                            <div class="card-body p-3 p-md-4">
                                <div class="row g-3 g-md-4">
                                    <div class="col-12 col-md-4">
                                        <img th:src="@{${publicacion.imagen}}"
                                             alt="Imagen de la mascota"
                                             class="img-fluid rounded w-100"
                                             style="height: 250px; object-fit: cover;">
                                    </div>
                                    <div class="col-12 col-md-8">
                                        <h3 class="h5 fw-bold mb-3" th:text="${publicacion.titulo}"></h3>

                                        <div class="d-flex flex-wrap gap-3 mb-3 small text-muted">
                                            <span th:if="${publicacion instanceof T(com.tallerwebi.dominio.PublicacionAdopcion) or
                                                          publicacion instanceof T(com.tallerwebi.dominio.PublicacionRecaudacion) or
                                                          publicacion instanceof T(com.tallerwebi.dominio.PublicacionSalud)}">
                                                <i class="fa-solid fa-calendar-days"></i>
                                                <span th:text="${publicacion.edad}"></span> años
                                            </span>
                                            <span>
                                                <i class="fa-solid fa-location-dot"></i>
                                                <span th:text="${publicacion.localidad}"></span>
                                            </span>
                                            <span>
                                                <i class="fa-solid fa-paw"></i>
                                                <span th:text="${publicacion.raza}"></span>
                                            </span>
                                        </div>

                                        <p class="text-muted mb-4" th:text="${publicacion.descripcionCorta}"></p>

                                        <div class="d-flex flex-wrap gap-2">
                                            <a th:href="@{/chat(iniciarCon=${publicacion.usuario.nombreDeUsuario})}"
                                               class="btn btn-warning btn-sm">
                                                <i class="fa-solid fa-comment-dots"></i> Consultar
                                            </a>
                                            <a th:href="@{/publicacion/{id}(id=${publicacion.id})}"
                                               class="btn btn-dark btn-sm">
                                                <i class="fa-solid fa-info-circle"></i> Más info
                                            </a>
                                            <a th:href="@{/publicacion/{id}(id=${publicacion.id})}"
                                               class="btn btn-secondary btn-sm">
                                                <i class="fa-solid fa-comments"></i>
                                                <span th:text="${publicacion.comentarios != null ? #lists.size(publicacion.comentarios) : 0}"></span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer mt-5"></footer>

<script type="text/javascript" th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.min.js}"></script>
<script th:src="@{/js/filtros.js}"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


</body>
</html>